#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ –æ–±—É—á–µ–Ω–∏—è MNIST –Ω–∞ —á–∏—Å—Ç–æ–º numpy –∏ pandas —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ö—ç—à–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

VENV_DIR="venv"
HASH_FILE=".requirements.hash"
REQ_FILE="requirements.txt"

echo "=============================="
echo "  üß© MNIST PROJECT BOOTSTRAP "
echo "=============================="

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Å–æ–∑–¥–∞—ë–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if [ -d "$VENV_DIR" ]; then
    echo "‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ '$VENV_DIR' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
else
    echo "üöÄ –°–æ–∑–¥–∞—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ '$VENV_DIR'..."
    python3 -m venv $VENV_DIR
fi

# 2. –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
echo "üîë –ê–∫—Ç–∏–≤–∏—Ä—É—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
source $VENV_DIR/bin/activate

# 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ requirements.txt
if [ -f "$REQ_FILE" ]; then
    NEW_HASH=$(sha256sum "$REQ_FILE" | awk '{print $1}')
    OLD_HASH=$(cat "$HASH_FILE" 2>/dev/null)

    if [ "$NEW_HASH" != "$OLD_HASH" ]; then
        echo "üîÑ requirements.txt –∏–∑–º–µ–Ω–∏–ª—Å—è –∏–ª–∏ hash-—Ñ–∞–π–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç."
        echo "üì¶ –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."

        pip install --upgrade pip
        pip install -r "$REQ_FILE"

        echo "$NEW_HASH" > "$HASH_FILE"
        echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏ hash –æ–±–Ω–æ–≤–ª—ë–Ω."
    else
        echo "‚úÖ requirements.txt –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è. –ü—Ä–æ–ø—É—Å–∫–∞—é —É—Å—Ç–∞–Ω–æ–≤–∫—É –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π."
    fi
else
    echo "‚ùå –§–∞–π–ª $REQ_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ."
    deactivate
    exit 1
fi

# 4. –ó–∞–ø—É—Å–∫ main.py
echo "üèÅ –ó–∞–ø—É—Å–∫–∞—é –ø—Ä–æ—Ü–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ –Ω–∞ MNIST —Å numpy + pandas..."
python3 main.py

# 5. –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "üõë –ó–∞–≤–µ—Ä—à–∞—é —Å–µ—Å—Å–∏—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è."
deactivate

echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à—ë–Ω."
echo "–ü–æ—Å–º–æ—Ç—Ä–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –≤–µ—Å–∞ –º–æ–¥–µ–ª–∏ –∏ –≥—Ä–∞—Ñ–∏–∫–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞."
